'use client';
import { useState, useEffect, useRef } from "react";
import Image from "next/image";
import { gsap } from "gsap";
import { useGSAP } from "@gsap/react";

export default function Home() {
    const [scrolled, setScrolled] = useState(false);
    const SCROLL_THERESHOLD = 160;
    useEffect(() => {
        const handleScroll = () => {
            const isScrolled = window.scrollY > SCROLL_THERESHOLD;
            if (isScrolled !== scrolled) {
                setScrolled(isScrolled);
            }
        }

        window.addEventListener('scroll', handleScroll);
        return () => {
            window.removeEventListener('scroll', handleScroll);
        }
    }, [scrolled])

    return (
        <div className="w-full flex flex-col no-scrollbar">
            <nav className="fixed">
                <div className="w-screen flex flex-row justify-between">
                    <div className="ml-20 mt-16 text-gray-900 text-xl text-bold">THE SHIFT</div>
                    {scrolled ? (
                        <button className="m-20">MENU</button>
                    ) : (
                        <ul className="mr-24 mt-16 -space-y-1">
                            <li className="text-black text-bold text-xl underline">HOME</li>
                            <li className="text-black text-bold text-xl no-underline hover:underline">PROJECT</li>
                            <li className="text-black text-bold text-xl no-underline hover:underline">RESEARCH</li>
                            <li className="text-black text-bold text-xl no-underline hover:underline">ABOUT</li>
                        </ul>
                    )}
                </div>
            </nav>
            <div className="bg-zinc-100 h-screen flex flex-col justify-center items-center text-black">
                <button className="absolute translate-x-144 -translate-y-96 border-black border-[1px] h-7 w-12 rounded-full">JA</button>
                <div className="-space-y-[92px] -translate-y-24">
                    <h1 className="mt-40 text-[152px] w-200 -translate-x-12">EXPLORING</h1>
                    <h1 className="text-[152px] w-200 -translate-x-[320px]">THE SHIFT</h1>
                    <h1 className="text-[152px] w-200">OF TODAY</h1>

                </div>
                {/* FIX: Change HTML/CSS editor to not strip these whitespaces lmao */}
                <pre className="absolute text-sm translate-x-120 w-80 leading-4">
                    ________THE SHIFT CREATES FUTURE-<br />
                    INSPIRED PROJECTS FOR PEOPLE AND<br />
                    BUSINESSES DESIRING A SHIFT. BASED IN<br />
                    TOKYO, WORKING WORLDWIDE.</pre>
                <div className="absolute bottom-20 left-20">
                    <DeviceClock />
                </div>
                <div className="absolute bottom-0 right-20 -mb-40 h-112 w-84 rounded-full bg-red-400"></div>
            </div>

            <div className="bg-gray-950 h-screen w-full flex flex-col justify-center items-center">
                <h1 className="flex justify-center m-4 text-lg text-neutral-200">WHAT WE DO</h1>
                <hr className="h-[1px] w-11/12 bg-gray-200 m-16 opacity-20"></hr>
                <h2 className="flex w-5/6 text-center text-5xl font-light mb-20 text-neutral-200">The Shift is a creative collective based in Tokyo. We provide new perspectives and solutions.</h2>
                <a href="/about_us" className="text-lg text-gray-800 font-light justify-center h-40 w-40 rounded-full bg-zinc-100 underline hover:no-underline flex justify-center items-center">ABOUT US</a>
            </div>

            <div className="bg-zinc-100 h-[275vh] flex flex-col justify-start items-center">
                <h1 className="w-60 mt-16 text-black text-bold text-xl text-center text-neutral-900">FEATURED PROJECT AND RESEARCH</h1>
                <a href="/projects" className="mt-60 mb-12 text-gray-500 underline hover:no-underline">VIEW ALL PROJECT</a>
                <hr className="h-[2px] w-11/12 bg-neutral-900 mt-12"></hr>
                <PortfolioList />
            </div>

            <div className="bg-neutral-900 h-[200vh] flex flex-col items-center">
                <h1 className="font-medium text-xl text-neutral-200 mt-16 mb-60 w-44 text-center">OUR TERRITORY AND FIELDS</h1>
                <a href="/about_us" className="underline hover:no-underline text-neutral-200 text-lg">ABOUT US</a>
                <hr className="h-[1px] w-11/12 bg-neutral-500 my-20 opacity-20"></hr>
                <p>Sliding to the left banner</p>
                <p>Sliding to the right banner</p>
                <hr className="border-t border-gray-400"></hr>
            </div>

            <div className="h-[100vh] w-full grid grid-rows-4 items-center">
                <div className="flex justify-around items-center h-full w-11/12 border-b border-neutral-500">
                    <button>JA</button>
                    <p>BASED IN TOKYO WORKING WORLDWIDE</p>
                    <div>
                        <p>BACK TO TOP</p>
                        <button>Up arrow</button>
                    </div>
                </div>
                <p className="row-span-2 justify-center text-9xl text-neutral-200 flex text-center h-full w-11/12 border-b border-neutral-500">GET IN TOUCH</p>

                <div className="h-full flex justify-around items-center">
                    <p>@2021</p>
                    <a href="www.instagram.com" className="underline hover:no-underline">INSTAGRAM</a>
                    <button>DARK MODE</button>
                </div>
            </div>
        </div>

    );
}

function getCurrentDeviceTime() {
    const now = new Date();
    const formatter = new Intl.DateTimeFormat('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hourCycle: 'h23',
    });

    return formatter.format(now);
}

function DeviceClock() {
    // NOTE: we set it to "" first since when Next.js builds the HTML on the server, it calls getCurrentdeviceTmie() once and retnders the inital time (e.g., 11:00:54). This time embedded in the HTML sent to the browser.
    // When the browser receives the HTML and React attempts to "hydrate" (attach event listeners and state) to the DOM, it runs the DeviceClock component again; since 1s has passed, React compares the 2 texts and throws the hydration mismatch error when they don't match.

    const [currentTime, setCurrentTime] = useState("");
    useEffect(() => {
        const timerId = setInterval(() => {
            setCurrentTime(getCurrentDeviceTime());
        }, 1000);
        return () => {
            clearInterval(timerId);
        }
    }, []);

    return (
        <p className="font-light text-gray-600">东京 {currentTime}</p>
    );
}

type ListItemProps = {
    num: string;
    title: string;
    height: string;
    width: string;
    hrBottom: number;
};

const listItems: ListItemProps[] = [
    { num: '01', title: 'FOCUS ON STRETCH PLEATS', height: 'h-72', width: 'w-5/8', hrBottom: 4 },
    { num: '02', title: 'LEVEL OF DISTANCE', height: 'h-72', width: 'w-1/2', hrBottom: 4 },
    { num: '03', title: 'IPSA AQUA PLAY ART', height: 'h-72', width: 'w-1/3', hrBottom: 4 },
    { num: '04', title: 'ATELIER WEN', height: 'h-72', width: 'w-1/2', hrBottom: 4 },
    { num: '05', title: '3D:MIX', height: 'h-136', width: 'w-1/2', hrBottom: 68 },
];

const ListItem: React.FC<ListItemProps> = ({ num, title, height, width, hrBottom }) => {
    // 1. Ref for the entire li element (used for useGSAP scope)
    const listItemRef = useRef<HTMLLIElement>(null);

    // 2. Refs for the elements to be animated
    const numRef = useRef<HTMLSpanElement>(null);
    const titleRef = useRef<HTMLParagraphElement>(null);

    // 3. Ref to store the GSAP timeline instance
    const tlRef = useRef<gsap.core.Timeline | null>(null);

    // Use useGSAP to create and manage the animation timeline
    useGSAP(() => {
        // Create the timeline, paused by default
        const tl = gsap.timeline({
            paused: true,
            defaults: { duration: 0.6, ease: 'power2.inOut' }
        });

        // Animate both the number span and the title paragraph to the right
        // We use the refs directly for clean targeting
        tl.to(numRef.current, { x: -160 }, 0)
            .to(titleRef.current, { x: -160 }, 0);

        // Store the timeline instance for later play/reverse control
        tlRef.current = tl;

    }, { scope: listItemRef, dependencies: [] }); // Empty dependencies ensures it runs only once

    // Handler to play the animation forward on mouse enter/focus
    const handleMouseEnter = () => {
        tlRef.current?.play();
    };

    // Handler to reverse the animation on mouse leave/blur
    const handleMouseLeave = () => {
        tlRef.current?.reverse();
    };

    return (
        <li
            ref={listItemRef} // Attach the scope ref here
            tabIndex={0}
            className={`${height} w-full flex relative mt-20 cursor-pointer`}
            onMouseEnter={handleMouseEnter}
            onMouseLeave={handleMouseLeave}
            onFocus={handleMouseEnter} // Handle keyboard focus
            onBlur={handleMouseLeave}
        >
            <span
                ref={numRef}
                className="text-neutral-500 text-sm ml-32 mr-10 relative z-10 inline-block transform-gpu"
            >
                ( {num} )
            </span>

            <p
                ref={titleRef}
                className={`text-8xl text-left text-neutral-900 ${width} relative z-10 inline-block transform-gpu`}
            >
                {title}
            </p>

            {/* The HR separator */}
            <hr className={`h-[2px] w-full bg-neutral-500 opacity-20 absolute bottom-${hrBottom} left-1/2 -translate-x-1/2`}></hr>
        </li>
    );
};

// Main component to render the list
const PortfolioList = () => {
    return (
        <div className="min-h-screen bg-zinc-100 text-neutral-900 font-inter">
            <ol className="items-start w-full">
                {listItems.map((item, index) => (
                    <ListItem
                        // Using index as key is acceptable here since the list is static
                        key={index}
                        num={item.num}
                        title={item.title}
                        height={item.height}
                        width={item.width}
                        hrBottom={item.hrBottom}
                    />
                ))}
            </ol>
        </div>
    );
};

const topString = "SHIFT PRODUCE DIRECTION DESIGN TECHNOLOGY CONSULTING BRANDING STRATEGY";
function TopInfiniteMarquee() {
    const containerRef = useRef<HTMLDivElement>(null);
    const textRef = useRef<HTMLDivElement>(null);
    useGSAP(() => {
        const container = containerRef.current;
        const text = textRef.current;
        if (!container || !text) return;

        const distanceToMove = text.scrollWidth / 2;
        const duration = 10;
        gsap.to(text, {
            x: -distanceToMove, duration: duration, ease: 'none', repeat: -1,
        });

    }, { scope: containerRef, dependencies: [] });

    return (
        <div
            ref={containerRef}
            className="w-full overflow-hidden whitespace-nowrap bg-neutral-900 text-white py-4 text-4xl font-bold"
        >
            <div
                ref={textRef}
                className="inline-block"
            >
                {topString}
            </div>
        </div>
    );
}
